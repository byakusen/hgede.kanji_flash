<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<!-- ã‚¹ãƒãƒ›ã§ã®æ‹¡å¤§ç¸®å°ã‚’ç¦æ­¢ã—ã€ã‚¢ãƒ—ãƒªã®ã‚ˆã†ãªæ“ä½œæ„Ÿã‚’å®Ÿç¾ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>ã‚«ã‚¹ã‚¿ãƒ ãƒ»ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</title>

<!-- Google Fonts: è¦ªã—ã¿ã‚„ã™ã„ä¸¸ã‚´ã‚·ãƒƒã‚¯ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">

<!-- ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨CDN -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<style>
  :root {
    --text-color: #334155;
    --bg-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    --glass-bg: rgba(255, 255, 255, 0.45);
    --glass-border: rgba(255, 255, 255, 0.6);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    --primary: #38bdf8;
    --good: #22c55e;
    --bad: #ef4444;
  }

  * { box-sizing: border-box; }

  /* 1ç”»é¢å®Œçµãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  body {
    margin: 0;
    min-height: 100vh;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    background: var(--bg-gradient);
    color: var(--text-color);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
  }

  /* ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚°ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ï¼‰ */
  #app-container {
    width: 95%;
    max-width: 480px;
    height: 90vh;
    max-height: 850px;
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    box-shadow: var(--glass-shadow);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–: ã‚¹ãƒãƒ›ç”»é¢ã§ã¯å…¨ç”»é¢è¡¨ç¤º */
  @media (max-width: 500px) {
    #app-container {
      width: 100%;
      height: 100vh;
      max-height: 100vh;
      border-radius: 0;
      border: none;
    }
  }

  /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆç”¨ã‚¯ãƒ©ã‚¹ */
  .view {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    padding: 24px;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease, transform 0.4s ease;
    transform: translateY(10px);
  }
  .view.active {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  /* --- å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
  h1, h2 { margin: 0 0 16px 0; text-align: center; }
  
  .btn {
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.8);
    border-radius: 16px;
    padding: 12px 20px;
    font-family: inherit;
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .btn:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: translateY(-2px);
  }
  .btn:active { transform: translateY(0); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  
  .btn.primary { background: rgba(56, 189, 248, 0.8); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); border:none;}
  .btn.primary:hover { background: rgba(14, 165, 233, 0.9); }
  .btn.good { background: rgba(34, 197, 94, 0.8); color: white; border:none;}
  .btn.bad { background: rgba(239, 68, 68, 0.8); color: white; border:none;}

  /* --- è¨­å®šç”»é¢ (Home View) --- */
  .control-group {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }
  select {
    flex: 1;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    background: rgba(255,255,255,0.7);
    font-family: inherit;
    font-size: 1rem;
    outline: none;
  }
  .editor-container {
    flex: 1;
    min-height: 0; /* Flexboxã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒã‚°å›é¿ */
    display: flex;
    flex-direction: column;
    margin-bottom: 16px;
  }
  .editor-label {
    font-size: 0.85rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: #475569;
  }
  textarea {
    flex: 1;
    width: 100%;
    resize: none;
    border-radius: 16px;
    border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.5);
    padding: 16px;
    font-family: inherit;
    font-size: 1rem;
    line-height: 1.5;
    outline: none;
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
    transition: background 0.3s;
  }
  textarea:focus { background: rgba(255, 255, 255, 0.8); border-color: var(--primary); }

  /* --- è¡¨å½¢å¼ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
  .data-table {
    flex: 1;
    overflow-y: auto;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.4);
    padding: 8px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    border: 1px solid var(--glass-border);
    box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
  }
  .data-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .data-row input {
    flex: 1;
    min-width: 0; /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ç¸®å°ã‚’è¨±å¯ */
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.7);
    font-family: inherit;
    font-size: 1rem;
    outline: none;
    transition: background 0.2s, border-color 0.2s;
  }
  .data-row input:focus {
    background: rgba(255, 255, 255, 0.95);
    border-color: var(--primary);
  }
  .del-row-btn {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    border: none;
    border-radius: 8px;
    width: 36px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: bold;
    font-size: 1.1rem;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .del-row-btn:hover {
    background: rgba(239, 68, 68, 0.9);
    color: white;
  }
  /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å°‘ã—ç´°ãç¶ºéº—ã«ã™ã‚‹ */
  .data-table::-webkit-scrollbar { width: 6px; }
  .data-table::-webkit-scrollbar-track { background: transparent; }
  .data-table::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 4px; }

  /* --- ãƒ—ãƒ¬ã‚¤ç”»é¢ (Play View) --- */
  .header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .progress-text { font-weight: 700; font-size: 1.2rem; }
  
  .card-container {
    flex: 1;
    min-height: 0;
    perspective: 1000px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
  }
  .card {
    width: 100%;
    height: 100%;
    max-height: 350px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.5s cubic-bezier(0.4, 0.2, 0.2, 1);
    cursor: pointer;
  }
  .card.flipped { transform: rotateY(180deg); }
  
  .card-face {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    background: rgba(255, 255, 255, 0.85);
    border-radius: 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px;
    border: 2px solid white;
  }
  .card-back { transform: rotateY(180deg); background: rgba(248, 250, 252, 0.95); }
  
  .card-label {
    position: absolute;
    top: 16px;
    font-size: 0.85rem;
    color: #94a3b8;
    font-weight: 700;
    letter-spacing: 0.1em;
  }
  .card-text {
    font-size: clamp(2rem, 8vw, 3.5rem);
    font-weight: 700;
    text-align: center;
    line-height: 1.3;
    word-break: break-word;
  }

  .action-area { display: flex; flex-direction: column; gap: 12px; }
  .judge-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  /* --- çµæœç”»é¢ (Result View) --- */
  .result-box {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  .score { font-size: 4rem; font-weight: 700; color: var(--primary); margin: 10px 0; }
  .stat-row { display: flex; gap: 20px; margin-bottom: 30px; }
  .stat-item { background: rgba(255,255,255,0.6); padding: 10px 20px; border-radius: 12px; font-weight: 700;}

  /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
  #toast {
    position: fixed;
    top: 20px; left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 0.9rem;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    z-index: 1000;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* --- å®Ÿç¸¾ãƒ»ç§°å· --- */
  .achievement-box {
    background: rgba(255, 255, 255, 0.6);
    border-radius: 16px;
    padding: 12px;
    margin-bottom: 10px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.8);
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  .title-badge {
    display: inline-block;
    background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    margin-bottom: 8px;
  }
  .stamps {
    min-height: 1.8rem;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 4px;
  }
  /* ã¯ãªã¾ã‚‹ç”»åƒã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .hanamaru-img {
    width: 28px;
    height: 28px;
    object-fit: contain;
  }
  .hanamaru-large {
    width: 90px;
    height: 90px;
    object-fit: contain;
  }
  .stamp-anim {
    animation: stampPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  }
  @keyframes stampPop {
    0% { transform: scale(0) rotate(-20deg); opacity: 0; }
    50% { transform: scale(1.5) rotate(10deg); }
    100% { transform: scale(1) rotate(0deg); opacity: 1; }
  }
  .new-title-msg {
    color: #ef4444;
    font-weight: bold;
    font-size: 1.1rem;
    margin-top: 10px;
    animation: bounce 1s infinite;
  }
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }

  /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆåå‰å…¥åŠ›ç”¨ï¼‰ --- */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  .modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }
  .modal-content {
    background: white;
    padding: 24px;
    border-radius: 20px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: translateY(20px);
    transition: transform 0.3s;
  }
  .modal-overlay.active .modal-content {
    transform: translateY(0);
  }
</style>
</head>
<body>

<div id="toast">ä¿å­˜ã—ã¾ã—ãŸ</div>

<!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆåå‰ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ç”¨ï¼‰ -->
<div id="input-modal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="modal-title" style="margin-top:0; color:var(--text-color); white-space: pre-wrap;">åå‰ã‚’å…¥åŠ›</h3>
    <input type="text" id="modal-input" style="width:100%; padding:12px; border-radius:12px; border:1px solid #ccc; font-size:1.1rem; margin-bottom:16px; outline:none;" />
    <div style="display:flex; gap:10px;">
      <button class="btn" id="modal-cancel" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn primary" id="modal-ok" style="flex:1;">OK</button>
    </div>
  </div>
</div>

<!-- â˜… ç¢ºèªç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå‰Šé™¤æ™‚ãªã©ï¼‰ -->
<div id="confirm-modal" class="modal-overlay">
  <div class="modal-content" style="text-align:center;">
    <h3 id="confirm-msg" style="margin-top:0; color:var(--text-color); font-size:1.2rem; line-height:1.5;">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</h3>
    <div style="display:flex; gap:10px; margin-top:24px;">
      <button class="btn" id="confirm-cancel" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn bad" id="confirm-ok" style="flex:1;">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- â˜… ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆè­¦å‘Šï¼‰ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="alert-modal" class="modal-overlay">
  <div class="modal-content" style="text-align:center;">
    <h3 id="alert-msg" style="margin-top:0; color:var(--text-color); font-size:1.1rem; line-height:1.5; white-space:pre-wrap;"></h3>
    <button class="btn primary" id="alert-ok" style="width:100%; margin-top:20px;">OK</button>
  </div>
</div>

<!-- â˜… ä¸€æ‹¬å…¥åŠ›ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="bulk-modal" class="modal-overlay">
  <div class="modal-content" style="max-width: 500px;">
    <h3 style="margin-top:0; color:var(--text-color);">Excelã‹ã‚‰ä¸€æ‹¬å…¥åŠ›</h3>
    <p style="font-size:0.9rem; color:#64748b; margin-bottom:12px;">Excelã‚„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ã‚³ãƒ”ãƒ¼ã—ãŸã€Œå•é¡Œã€ã¨ã€Œç­”ãˆã€ã®2åˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã€ä¸‹ã®æ ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ï¼‰</p>
    <textarea id="bulk-input-area" style="width:100%; height:150px; padding:12px; border-radius:12px; border:1px solid #ccc; font-size:1rem; margin-bottom:16px; outline:none; resize:none;" placeholder="ã“ã“ã¸è²¼ã‚Šä»˜ã‘ï¼ˆãƒšãƒ¼ã‚¹ãƒˆï¼‰"></textarea>
    <div style="display:flex; gap:10px;">
      <button class="btn" id="bulk-cancel" style="flex:1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn primary" id="bulk-ok" style="flex:1;">ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚€</button>
    </div>
  </div>
</div>

<div id="app-container">
  
  <!-- ã€0ã€‘ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ (å­ä¾›å‘ã‘) -->
  <div id="view-start" class="view active">
    <div style="position: absolute; top: 16px; right: 16px;">
      <button class="btn" id="go-settings-btn" style="padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.6); font-size: 0.9rem;" title="è¨­å®šç”»é¢ã‚’é–‹ã">âš™ï¸ è¨­å®š</button>
    </div>
    <h2 style="margin-top: 20px; font-size: 1.8rem; color: var(--primary);">ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</h2>
    
    <!-- â˜… å®Ÿç¸¾è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="achievement-box" id="start-achievement">
      <div class="title-badge" id="start-title-badge">è¦‹ç¿’ã„</div>
      <div style="font-size: 0.85rem; color: #64748b; margin-bottom:4px;">é›†ã‚ãŸã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆå›æ•°: <span id="perfect-count">0</span>ï¼‰</div>
      <div class="stamps" id="start-stamps"></div>
    </div>
    
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; gap: 16px; padding: 0 10px;">
      <div>
        <div style="font-weight:700; margin-bottom:8px; text-align:center; color: #475569;">ãƒ†ã‚¹ãƒˆã™ã‚‹å•é¡Œã‚»ãƒƒãƒˆ</div>
        <select id="start-set-select" style="width:100%; font-size:1.2rem; padding:16px; border-radius: 16px;"></select>
      </div>

      <div>
        <div style="font-weight:700; margin-bottom:8px; text-align:center; color: #475569;">å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰</div>
        <select id="start-mode-select" style="width:100%; font-size:1.2rem; padding:16px; border-radius: 16px;">
          <option value="all">å…¨å•ãƒ†ã‚¹ãƒˆã™ã‚‹</option>
          <option value="random10">ãƒ©ãƒ³ãƒ€ãƒ ã«10å•</option>
          <option value="random20">ãƒ©ãƒ³ãƒ€ãƒ ã«20å•</option>
        </select>
      </div>

      <button class="btn primary" id="start-test-btn" style="padding: 24px; font-size: 1.4rem; margin-top:16px; border-radius: 20px;">â–¶ ãƒ†ã‚¹ãƒˆé–‹å§‹ï¼</button>
    </div>
  </div>

  <!-- ã€1ã€‘è¨­å®šç”»é¢ (å…ˆç”Ÿå‘ã‘) -->
  <div id="view-home" class="view">
    <div class="header-bar" style="margin-bottom: 12px;">
      <button class="btn" id="close-settings-btn" style="padding: 6px 12px; font-size:0.85rem;">â—€ æˆ»ã‚‹</button>
      <h2 style="margin:0; font-size:1.2rem;">è¨­å®š</h2>
      <button class="btn" id="change-pw-btn" style="padding: 6px 12px; font-size:0.85rem;" title="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´">ğŸ”‘ PWå¤‰æ›´</button>
    </div>
    
    <div class="control-group">
      <select id="set-select" style="min-width: 140px;"></select>
      <button class="btn" id="rename-set-btn" title="ã‚»ãƒƒãƒˆåã‚’å¤‰æ›´" style="padding: 8px;">âœï¸ åå‰å¤‰æ›´</button>
      <button class="btn" id="new-set-btn" title="æ–°ã—ã„ã‚»ãƒƒãƒˆã‚’ä½œæˆ" style="padding: 8px;">ï¼‹ æ–°è¦è¿½åŠ </button>
      <button class="btn" id="share-set-btn" title="ã“ã®ã‚»ãƒƒãƒˆã®å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼" style="padding: 8px;">ğŸ”— å…±æœ‰</button>
      <button class="btn" id="del-set-btn" title="ã“ã®ã‚»ãƒƒãƒˆã‚’å‰Šé™¤" style="padding: 8px;">ğŸ—‘ï¸ å‰Šé™¤</button>
    </div>

    <div class="editor-container">
      <div class="editor-label" style="display: flex; justify-content: space-between; align-items: center;">
        <span>å•é¡Œãƒ‡ãƒ¼ã‚¿</span>
        <div style="display:flex; gap:8px;">
          <!-- â˜… ä¸€æ‹¬å…¥åŠ›ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
          <button id="bulk-input-btn" class="btn" style="padding: 4px 10px; font-size: 0.8rem; border-radius: 8px; background: rgba(255,255,255,0.8);">ğŸ“‹ Excelä¸€æ‹¬å…¥åŠ›</button>
          <button id="add-row-btn" class="btn" style="padding: 4px 10px; font-size: 0.8rem; border-radius: 8px; background: rgba(255,255,255,0.8);">ï¼‹ è¡Œã‚’è¿½åŠ </button>
        </div>
      </div>
      <div id="data-table" class="data-table">
        <!-- JSã§ã“ã“ã«è¡ŒãŒè¿½åŠ ã•ã‚Œã¾ã™ -->
      </div>
    </div>

    <button class="btn primary" id="save-btn" style="width:100%; padding:14px; margin-top:10px;">ä¿å­˜ã—ã¦æˆ»ã‚‹</button>
  </div>

  <!-- ã€2ã€‘ãƒ—ãƒ¬ã‚¤ç”»é¢ -->
  <div id="view-play" class="view">
    <div class="header-bar">
      <button class="btn" id="back-home-btn" style="padding: 6px 12px; font-size:0.85rem;">â—€ æˆ»ã‚‹</button>
      <div class="progress-text"><span id="current-num">1</span> / <span id="total-num">10</span></div>
    </div>

    <div class="card-container">
      <div class="card" id="flashcard">
        <div class="card-face">
          <div class="card-label">ã‚‚ã‚“ã ã„</div>
          <div class="card-text" id="card-front">è¡¨</div>
        </div>
        <div class="card-face card-back">
          <div class="card-label">ã“ãŸãˆ</div>
          <div class="card-text" id="card-back">è£</div>
        </div>
      </div>
    </div>

    <div class="action-area">
      <button class="btn primary" id="reveal-btn" style="padding: 16px;">ç­”ãˆã‚’è¦‹ã‚‹ (Space)</button>
      <div class="judge-btns">
        <button class="btn bad" id="ng-btn" disabled>âœ– ã‚ã‹ã‚‰ãªã‹ã£ãŸ</button>
        <button class="btn good" id="ok-btn" disabled>ã€‡ æ­£è§£ã—ãŸï¼</button>
      </div>
    </div>
  </div>

  <!-- ã€3ã€‘çµæœç”»é¢ -->
  <div id="view-result" class="view">
    <div class="result-box">
      <h2 id="result-title">ãƒ†ã‚¹ãƒˆçµ‚äº†ï¼</h2>
      <div class="score" id="result-score">100%</div>
      
      <!-- â˜… æ–°ã—ã„ç§°å·ç²å¾—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div id="new-title-msg" class="new-title-msg" style="display:none;">ğŸ‰ æ–°ã—ã„ç§°å·ã€Œ<span id="new-title-name"></span>ã€ã‚’ç²å¾—ï¼</div>
      
      <div class="stat-row" style="margin-top: 10px; margin-bottom: 10px;">
        <div class="stat-item" style="color: var(--good);">ã€‡ æ­£è§£: <span id="res-ok">0</span></div>
        <div class="stat-item" style="color: var(--bad);">âœ– èª¤ç­”: <span id="res-ng">0</span></div>
      </div>

      <!-- â˜… ç²å¾—ã—ãŸã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º -->
      <div id="result-stamp" style="font-size: 4.5rem; height: 80px; display:flex; align-items:center; justify-content:center; margin-bottom:20px;"></div>

      <div style="display:flex; flex-direction:column; gap:12px; width:100%;">
        <!-- â˜… çµæœã‚’å ±å‘Šã™ã‚‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
        <button class="btn good" id="report-btn" style="padding:16px;">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…ˆç”Ÿã«å ±å‘Š</button>
        <button class="btn primary" id="retry-ng-btn" style="display:none; padding:16px;">é–“é•ãˆãŸå•é¡Œã ã‘å¾©ç¿’</button>
        <button class="btn" id="retry-all-btn">ã‚‚ã†ä¸€åº¦æœ€åˆã‹ã‚‰</button>
        <button class="btn" id="to-home-btn">æœ€åˆã®ç”»é¢ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

</div>

<script>
// ==========================================
// 1. åˆæœŸãƒ‡ãƒ¼ã‚¿ã¨çŠ¶æ…‹ç®¡ç†
// ==========================================
const DEFAULT_DATA = {
  "æ¼¢å­—": [
    {front:"", back:""}
  ]
};

let appData = {};
let currentSetName = "";
let playDeck = [];
let wrongCards = [];
let currentCardIndex = 0;
let stats = { ok: 0, ng: 0 };
let isFlipped = false;
let isSharedMode = false; // â˜… å…±æœ‰ãƒªãƒ³ã‚¯ã§é–‹ã„ãŸã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ãƒ•ãƒ©ã‚°

// â˜… ç®¡ç†è€…ï¼ˆå…ˆç”Ÿï¼‰ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
let adminPassword = localStorage.getItem('custom_flashcards_password');

// â˜… å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿
let achievements = { perfects: 0 };
const TITLES = [
  { min: 0, name: "è¦‹ç¿’ã„" },
  { min: 1, name: "ãƒ«ãƒ¼ã‚­ãƒ¼" },
  { min: 3, name: "ãƒ–ãƒ­ãƒ³ã‚ºãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼" },
  { min: 5, name: "ã‚·ãƒ«ãƒãƒ¼ãƒ’ãƒ¼ãƒ­ãƒ¼" },
  { min: 10, name: "ã‚´ãƒ¼ãƒ«ãƒ‰ãƒã‚¹ã‚¿ãƒ¼" },
  { min: 20, name: "ãƒ—ãƒ©ãƒãƒŠãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰" },
  { min: 50, name: "ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ç¥" }
];

// åŠ¹æœéŸ³ã®æº–å‚™ (Wikimedia Commonsã®ç›´ãƒªãƒ³ã‚¯å¯èƒ½ãªãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‰ãƒ¡ã‚¤ãƒ³éŸ³æº)
const sounds = {
  ok: new Audio('https://upload.wikimedia.org/wikipedia/commons/a/a2/Chime_sound.ogg'),
  ng: new Audio('https://upload.wikimedia.org/wikipedia/commons/4/41/Buzzer.ogg')
};

// ==========================================
// 2. DOMè¦ç´ ã®å–å¾—
// ==========================================
const $ = id => document.getElementById(id);

const views = {
  start: $('view-start'),
  home: $('view-home'),
  play: $('view-play'),
  result: $('view-result')
};

const ui = {
  startSetSelect: $('start-set-select'), startModeSelect: $('start-mode-select'), startTestBtn: $('start-test-btn'),
  goSettingsBtn: $('go-settings-btn'), closeSettingsBtn: $('close-settings-btn'), changePwBtn: $('change-pw-btn'),
  setSelect: $('set-select'), dataTable: $('data-table'), addRowBtn: $('add-row-btn'), bulkInputBtn: $('bulk-input-btn'),
  newSetBtn: $('new-set-btn'), renameSetBtn: $('rename-set-btn'), shareSetBtn: $('share-set-btn'), delSetBtn: $('del-set-btn'), saveBtn: $('save-btn'),
  
  card: $('flashcard'), cardFront: $('card-front'), cardBack: $('card-back'),
  currNum: $('current-num'), totalNum: $('total-num'),
  revealBtn: $('reveal-btn'), okBtn: $('ok-btn'), ngBtn: $('ng-btn'), backHomeBtn: $('back-home-btn'),
  
  resTitle: $('result-title'), resScore: $('result-score'), resOk: $('res-ok'), resNg: $('res-ng'),
  retryNgBtn: $('retry-ng-btn'), retryAllBtn: $('retry-all-btn'), toHomeBtn: $('to-home-btn'), reportBtn: $('report-btn'),
  toast: $('toast'),
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
  modal: $('input-modal'), modalTitle: $('modal-title'), modalInput: $('modal-input'),
  modalOk: $('modal-ok'), modalCancel: $('modal-cancel'),
  
  // â˜… ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
  confirmModal: $('confirm-modal'), confirmMsg: $('confirm-msg'), confirmOk: $('confirm-ok'), confirmCancel: $('confirm-cancel'),
  
  // â˜… ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
  alertModal: $('alert-modal'), alertMsg: $('alert-msg'), alertOk: $('alert-ok'),

  // â˜… ä¸€æ‹¬å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
  bulkModal: $('bulk-modal'), bulkInputArea: $('bulk-input-area'), bulkOk: $('bulk-ok'), bulkCancel: $('bulk-cancel'),
  
  // å®Ÿç¸¾ç”¨
  startTitleBadge: $('start-title-badge'), perfectCount: $('perfect-count'), startStamps: $('start-stamps'),
  newTitleMsg: $('new-title-msg'), newTitleName: $('new-title-name'), resultStamp: $('result-stamp')
};

// ==========================================
// 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
// ==========================================
function initApp() {
  loadData();
  loadAchievements(); // å®Ÿç¸¾ã®èª­ã¿è¾¼ã¿
  
  // â˜…è¿½åŠ ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã®å…±æœ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  const urlParams = new URLSearchParams(window.location.search);
  const sharedData = urlParams.get('share');
  if (sharedData) {
    try {
      // æš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
      const decodedStr = decodeURIComponent(escape(atob(sharedData)));
      const parsedData = JSON.parse(decodedStr);
      
      if (parsedData.name && parsedData.data) {
        let setName = parsedData.name;
        // åŒã˜åå‰ã®ã‚»ãƒƒãƒˆãŒã‚ã‚Œã°ã€Œ(å…±æœ‰)ã€ã‚’ä»˜ã‘ã¦ä¸Šæ›¸ãã‚’é˜²ã
        if (appData[setName]) {
          setName = setName + " (å…±æœ‰)";
        }
        appData[setName] = parsedData.data;
        saveDataToStorage();
        currentSetName = setName;
        
        // â˜… å…±æœ‰ãƒ¢ãƒ¼ãƒ‰ã®ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦ã€è¨­å®šãƒœã‚¿ãƒ³ã‚’éš ã™
        isSharedMode = true;
        ui.goSettingsBtn.style.display = 'none';
        
        showToast("å…±æœ‰ã•ã‚ŒãŸå•é¡Œã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
      }
    } catch(e) {
      alert("å…±æœ‰ãƒªãƒ³ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLãŒé€”åˆ‡ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
    }
    // URLã‚’ãã‚Œã„ã«ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¶ˆå»ï¼‰
    window.history.replaceState({}, document.title, window.location.pathname);
  }

  renderSelect();
  loadSetToEditor();
  showView('start'); // åˆæœŸç”»é¢ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«å¤‰æ›´
}

function loadData() {
  try {
    const saved = localStorage.getItem('custom_flashcards_data');
    if (saved) {
      appData = JSON.parse(saved);
    } else {
      appData = JSON.parse(JSON.stringify(DEFAULT_DATA)); // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
    }
  } catch (e) {
    appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
  }
  const keys = Object.keys(appData);
  if (keys.length === 0) {
    appData["æ–°ã—ã„ã‚»ãƒƒãƒˆ"] = [{front:"å•é¡Œ", back:"ç­”ãˆ"}];
  }
  currentSetName = keys[0];
}

function saveDataToStorage() {
  localStorage.setItem('custom_flashcards_data', JSON.stringify(appData));
}

// â˜… å®Ÿç¸¾ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿
function loadAchievements() {
  try {
    const saved = localStorage.getItem('custom_flashcards_achievements');
    if (saved) {
      achievements = JSON.parse(saved);
    }
  } catch(e) {}
  updateAchievementUI();
}

function saveAchievements() {
  localStorage.setItem('custom_flashcards_achievements', JSON.stringify(achievements));
}

function getTitle(perfects) {
  let currentTitle = TITLES[0].name;
  for (let t of TITLES) {
    if (perfects >= t.min) currentTitle = t.name;
  }
  return currentTitle;
}

function updateAchievementUI() {
  const p = achievements.perfects;
  ui.startTitleBadge.textContent = getTitle(p);
  ui.perfectCount.textContent = p;
  
  // â˜… ã¯ãªã¾ã‚‹ç”»åƒã®è¡¨ç¤º
  ui.startStamps.innerHTML = '';
  const imgUrl = 'https://raw.githubusercontent.com/byakusen/hanamaru/refs/heads/main/hanamaru2.png';
  
  if (p === 0) return;

  // 20å€‹ã¾ã§ã¯ç”»åƒã‚’ä¸¦ã¹ã€ãã‚Œä»¥ä¸Šã¯ã€Œç”»åƒ Ã— 21ã€ã®ã‚ˆã†ã«è¡¨ç¤º
  if (p <= 20) {
    for (let i = 0; i < p; i++) {
      const img = document.createElement('img');
      img.src = imgUrl;
      img.className = 'hanamaru-img';
      ui.startStamps.appendChild(img);
    }
  } else {
    const img = document.createElement('img');
    img.src = imgUrl;
    img.className = 'hanamaru-img';
    ui.startStamps.appendChild(img);
    
    const text = document.createElement('span');
    text.textContent = ` Ã— ${p}`;
    text.style.fontSize = '1.2rem';
    text.style.fontWeight = 'bold';
    text.style.color = '#475569';
    ui.startStamps.appendChild(text);
  }
}

// ==========================================
// 4. ãƒ›ãƒ¼ãƒ ï¼ˆè¨­å®šï¼‰ç”»é¢ãƒ­ã‚¸ãƒƒã‚¯
// ==========================================
function renderSelect() {
  ui.setSelect.innerHTML = '';
  ui.startSetSelect.innerHTML = ''; // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ã‚»ãƒ¬ã‚¯ãƒˆã‚‚æ›´æ–°
  
  Object.keys(appData).forEach(name => {
    // å…ˆç”Ÿç”¨è¨­å®šç”»é¢ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
    const optHome = document.createElement('option');
    optHome.value = name;
    optHome.textContent = name;
    if (name === currentSetName) optHome.selected = true;
    ui.setSelect.appendChild(optHome);
    
    // å­ä¾›ç”¨ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
    const optStart = document.createElement('option');
    optStart.value = name;
    optStart.textContent = name;
    if (name === currentSetName) optStart.selected = true;
    ui.startSetSelect.appendChild(optStart);
  });
}

function createDataRow(front = "", back = "") {
  const row = document.createElement('div');
  row.className = 'data-row';
  
  const inputFront = document.createElement('input');
  inputFront.type = 'text';
  inputFront.value = front;
  inputFront.placeholder = 'å•é¡Œ';
  
  const inputBack = document.createElement('input');
  inputBack.type = 'text';
  inputBack.value = back;
  inputBack.placeholder = 'ç­”ãˆ';
  
  const delBtn = document.createElement('button');
  delBtn.className = 'del-row-btn';
  delBtn.innerHTML = 'âœ–';
  delBtn.title = 'è¡Œã‚’å‰Šé™¤';
  delBtn.onclick = () => {
    row.remove();
  };
  
  row.appendChild(inputFront);
  row.appendChild(inputBack);
  row.appendChild(delBtn);
  
  return row;
}

function loadSetToEditor() {
  ui.dataTable.innerHTML = '';
  const data = appData[currentSetName] || [];
  
  if (data.length === 0) {
    ui.dataTable.appendChild(createDataRow());
  } else {
    data.forEach(item => {
      ui.dataTable.appendChild(createDataRow(item.front, item.back));
    });
  }
}

function parseEditorData() {
  const parsed = [];
  const rows = ui.dataTable.querySelectorAll('.data-row');
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const front = inputs[0].value.trim();
    const back = inputs[1].value.trim();
    if (front || back) { // ã©ã¡ã‚‰ã‹ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°ä¿å­˜å¯¾è±¡
      parsed.push({
        front: front,
        back: back || 'ï¼ˆç­”ãˆãªã—ï¼‰'
      });
    }
  });
  // â˜… ã‚‚ã—ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¦ã„ãŸã‚‰ç©ºã®æ ã‚’ä½œã‚‹
  return parsed.length > 0 ? parsed : [{front:"", back:""}];
}

// å¼•æ•° showMsg ã§ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
function saveCurrentSet(showMsg = true) {
  appData[currentSetName] = parseEditorData();
  saveDataToStorage();
  if (showMsg) showToast("ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
}

function showToast(msg) {
  ui.toast.textContent = msg;
  ui.toast.classList.add('show');
  setTimeout(() => ui.toast.classList.remove('show'), 3000);
}

// ==========================================
// â˜… ãƒ¢ãƒ¼ãƒ€ãƒ«å…¥åŠ›å‡¦ç†
// ==========================================
let modalCallback = null;
function showInputModal(title, defaultText, callback, isPassword = false) {
  ui.modalTitle.textContent = title;
  ui.modalInput.type = isPassword ? 'password' : 'text'; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
  ui.modalInput.value = defaultText;
  modalCallback = callback;
  ui.modal.classList.add('active');
  ui.modalInput.focus();
}

ui.modalCancel.addEventListener('click', () => {
  ui.modal.classList.remove('active');
});

ui.modalOk.addEventListener('click', () => {
  ui.modal.classList.remove('active');
  if (modalCallback) modalCallback(ui.modalInput.value);
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§Enterã‚­ãƒ¼ã‚’æŠ¼ã—ãŸæ™‚ã«ã‚‚æ±ºå®šã™ã‚‹
ui.modalInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') ui.modalOk.click();
});

// ==========================================
// â˜… ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†
// ==========================================
let confirmCallback = null;
function showConfirmModal(msg, callback) {
  ui.confirmMsg.textContent = msg;
  confirmCallback = callback;
  ui.confirmModal.classList.add('active');
}
ui.confirmCancel.addEventListener('click', () => { ui.confirmModal.classList.remove('active'); });
ui.confirmOk.addEventListener('click', () => {
  ui.confirmModal.classList.remove('active');
  if (confirmCallback) confirmCallback();
});

// ==========================================
// â˜… ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†
// ==========================================
function showAlertModal(msg) {
  ui.alertMsg.textContent = msg;
  ui.alertModal.classList.add('active');
}
ui.alertOk.addEventListener('click', () => { ui.alertModal.classList.remove('active'); });


// ==========================================
// â˜… ä¸€æ‹¬å…¥åŠ›ï¼ˆExcelã‚³ãƒ”ãƒšï¼‰å‡¦ç†
// ==========================================
ui.bulkInputBtn.addEventListener('click', () => {
  ui.bulkInputArea.value = ''; // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ç©ºã«ã™ã‚‹
  ui.bulkModal.classList.add('active');
  ui.bulkInputArea.focus();
});

ui.bulkCancel.addEventListener('click', () => {
  ui.bulkModal.classList.remove('active');
});

ui.bulkOk.addEventListener('click', () => {
  const text = ui.bulkInputArea.value;
  if (!text.trim()) {
    ui.bulkModal.classList.remove('active');
    return;
  }
  
  const lines = text.split('\n'); // æ”¹è¡Œã§åŒºåˆ‡ã£ã¦1è¡Œãšã¤ã®é…åˆ—ã«ã™ã‚‹
  const newData = [];
  
  lines.forEach(line => {
    if (!line.trim()) return; // ç©ºè¡Œã¯ç„¡è¦–
    
    let front = '';
    let back = '';
    
    // Excelã‹ã‚‰ã‚³ãƒ”ãƒ¼ã™ã‚‹ã¨ã€ã‚»ãƒ«ã¨ã‚»ãƒ«ã®é–“ã¯ã€Œã‚¿ãƒ–ï¼ˆ\tï¼‰ã€ã«ãªã‚Šã¾ã™
    if (line.includes('\t')) {
      const parts = line.split('\t');
      front = parts[0] ? parts[0].trim() : '';
      back = parts[1] ? parts[1].trim() : 'ï¼ˆç­”ãˆãªã—ï¼‰';
    } else {
      // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆCSVï¼‰ã®å ´åˆã«ã‚‚å¯¾å¿œã—ã¦ãŠã
      const parts = line.split(',');
      front = parts[0] ? parts[0].trim() : '';
      back = parts[1] ? parts[1].trim() : 'ï¼ˆç­”ãˆãªã—ï¼‰';
    }
    
    if (front || back) {
      newData.push({ front, back });
    }
  });
  
  if (newData.length > 0) {
    saveCurrentSet(false); // ç¾åœ¨å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹è¡¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ—¦ä¿å­˜
    
    const currentData = appData[currentSetName] || [];
    
    // ã‚‚ã—åˆæœŸã®ç©ºã®è¡Œã ã‘ãªã‚‰ã€ãã‚Œã‚’æ¶ˆã—ã¦ç½®ãæ›ãˆã‚‹
    let mergedData = [];
    if (currentData.length === 1 && currentData[0].front === "" && currentData[0].back === "") {
      mergedData = newData;
    } else {
      // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã®å¾Œã‚ã«ã€æ–°ã—ãèª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’åˆä½“ï¼ˆè¿½åŠ ï¼‰ã•ã›ã‚‹
      mergedData = [...currentData, ...newData];
    }
    
    appData[currentSetName] = mergedData;
    loadSetToEditor(); // è¡¨ã‚’æ›¸ãæ›ãˆã‚‹
    saveDataToStorage();
    showToast(`${newData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
  }
  
  ui.bulkModal.classList.remove('active');
});

// ==========================================
// ç”»é¢é·ç§»ã‚¤ãƒ™ãƒ³ãƒˆ
ui.goSettingsBtn.addEventListener('click', () => {
  if (isSharedMode) return; // å¿µã®ãŸã‚ã€å…±æœ‰ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ä½•ã‚‚ã—ãªã„

  if (!adminPassword) {
    // åˆå›ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
    showInputModal("ã€åˆå›è¨­å®šã€‘\nå…ˆç”Ÿç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ±ºã‚ã¦ãã ã•ã„", "", (pw) => {
      if (pw) {
        adminPassword = pw;
        localStorage.setItem('custom_flashcards_password', pw);
        showAlertModal("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸã€‚\næ¬¡å›ã‹ã‚‰è¨­å®šç”»é¢ã‚’é–‹ãéš›ã«å¿…è¦ã«ãªã‚Šã¾ã™ã€‚");
        loadSetToEditor();
        showView('home');
      }
    }, true);
  } else {
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
    showInputModal("å…ˆç”Ÿç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "", (pw) => {
      if (pw === adminPassword) {
        loadSetToEditor();
        showView('home');
      } else if (pw) {
        showAlertModal("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ï¼");
      }
    }, true);
  }
});

ui.closeSettingsBtn.addEventListener('click', () => {
  saveCurrentSet(); // æˆ»ã‚‹æ™‚ã«è‡ªå‹•ä¿å­˜
  showView('start');
});

ui.saveBtn.addEventListener('click', () => {
  saveCurrentSet();
  showView('start');
});

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒœã‚¿ãƒ³ã®å‡¦ç†
ui.changePwBtn.addEventListener('click', () => {
  showInputModal("æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "", (pw) => {
    if (pw) {
      adminPassword = pw;
      localStorage.setItem('custom_flashcards_password', pw);
      showToast("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
    }
  }, true);
});

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ãƒ›ãƒ¼ãƒ /ã‚¹ã‚¿ãƒ¼ãƒˆå…±é€š)
ui.setSelect.addEventListener('change', (e) => {
  saveCurrentSet(false); // åˆ‡ã‚Šæ›¿ãˆå‰ã«ä¿å­˜(ãƒˆãƒ¼ã‚¹ãƒˆæŠ‘åˆ¶)
  currentSetName = e.target.value;
  loadSetToEditor();
  ui.startSetSelect.value = currentSetName; // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®é¸æŠã‚‚åŒæœŸ
});

ui.startSetSelect.addEventListener('change', (e) => {
  currentSetName = e.target.value;
  ui.setSelect.value = currentSetName; // è¨­å®šç”»é¢ã®é¸æŠã‚‚åŒæœŸ
});

ui.addRowBtn.addEventListener('click', () => {
  ui.dataTable.appendChild(createDataRow());
  ui.dataTable.scrollTop = ui.dataTable.scrollHeight; // è¿½åŠ å¾Œã€ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
});

ui.renameSetBtn.addEventListener('click', () => {
  saveCurrentSet(false); // æœ€æ–°ã®çŠ¶æ…‹ã‚’ä¿å­˜(ãƒˆãƒ¼ã‚¹ãƒˆæŠ‘åˆ¶)
  showInputModal("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", currentSetName, (newName) => {
    if (newName && newName.trim() && newName !== currentSetName) {
      if (appData[newName]) {
        showAlertModal("ãã®åå‰ã®ã‚»ãƒƒãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚åˆ¥ã®åå‰ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      // ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„åå‰ã«ç§»å‹•
      appData[newName] = appData[currentSetName];
      delete appData[currentSetName];
      currentSetName = newName;
      
      renderSelect();
      saveDataToStorage();
      showToast("åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼");
    }
  });
});

ui.newSetBtn.addEventListener('click', () => {
  saveCurrentSet(false); // ãƒˆãƒ¼ã‚¹ãƒˆæŠ‘åˆ¶
  showInputModal("æ–°ã—ã„ã‚»ãƒƒãƒˆã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "", (name) => {
    if (name && name.trim() && !appData[name]) {
      appData[name] = [{front:"æ–°ã—ã„å•é¡Œ", back:"æ–°ã—ã„ç­”ãˆ"}];
      currentSetName = name;
      renderSelect();
      loadSetToEditor();
      saveDataToStorage();
      showToast("æ–°ã—ãè¿½åŠ ã—ã¾ã—ãŸï¼");
    } else if (appData[name]) {
      showAlertModal("ãã®åå‰ã®ã‚»ãƒƒãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚");
    }
  });
});

// â˜… å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‡¦ç†ã‚’å¤‰æ›´ï¼ˆç‹¬è‡ªã®ç¢ºèªç”»é¢ã‚’ä½¿ã†ï¼‰
ui.delSetBtn.addEventListener('click', () => {
  showConfirmModal(`å•é¡Œã‚»ãƒƒãƒˆã€Œ${currentSetName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, () => {
    delete appData[currentSetName];
    
    // å…¨éƒ¨ã®ã‚»ãƒƒãƒˆãŒæ¶ˆãˆãŸå ´åˆã¯ã€ç©ºã®ã‚»ãƒƒãƒˆã‚’1ã¤ä½œã£ã¦ã‚ã’ã‚‹
    if (Object.keys(appData).length === 0) {
      appData["æ–°ã—ã„å•é¡Œã‚»ãƒƒãƒˆ"] = [{front: "", back: ""}];
    }
    
    currentSetName = Object.keys(appData)[0];
    renderSelect();
    loadSetToEditor();
    saveDataToStorage();
    showToast("ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ");
  });
});

ui.shareSetBtn.addEventListener('click', () => {
  saveCurrentSet(); // æœ€æ–°ã®çŠ¶æ…‹ã‚’ä¿å­˜
  
  const setData = {
    name: currentSetName,
    data: appData[currentSetName]
  };
  
  try {
    // ãƒ‡ãƒ¼ã‚¿ã‚’æ–‡å­—åˆ—åŒ–ã—ã¦URLã‚»ãƒ¼ãƒ•ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆæš—å·åŒ–ï¼‰
    const jsonStr = JSON.stringify(setData);
    const encodedStr = btoa(unescape(encodeURIComponent(jsonStr)));
    
    // ç¾åœ¨ã®URLã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ä¸ã—ã¦å…±æœ‰ç”¨ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
    const baseUrl = window.location.origin + window.location.pathname;
    
    // â˜… å…±æœ‰ãƒªãƒ³ã‚¯ãŒãƒ–ãƒ©ã‚¦ã‚¶ã§å¤‰æ›ã•ã‚Œãªã„ã‚ˆã†ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 
    const shareUrl = `${baseUrl}?share=${encodeURIComponent(encodedStr)}`;
    
    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
    const tempInput = document.createElement('input');
    tempInput.value = shareUrl;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    
    showToast("å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
  } catch(e) {
    showAlertModal("ãƒªãƒ³ã‚¯ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å•é¡Œã®æ•°ãŒå¤šã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
  }
});

// ==========================================
// 5. ãƒ—ãƒ¬ã‚¤ç”»é¢ãƒ­ã‚¸ãƒƒã‚¯
// ==========================================
function startTest() {
  const baseData = appData[currentSetName];
  const mode = ui.startModeSelect.value;
  
  // ç©ºã®ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯é™¤å¤–ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å§‹ã‚ã‚‹
  let validData = baseData.filter(item => item.front.trim() !== '' || item.back.trim() !== '');
  
  if (validData.length === 0) {
    showAlertModal("å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šã‹ã‚‰å•é¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼");
    return;
  }
  
  // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  let shuffled = [...validData].sort(() => Math.random() - 0.5);
  
  if (mode === 'random10') {
    playDeck = shuffled.slice(0, 10);
  } else if (mode === 'random20') {
    playDeck = shuffled.slice(0, 20);
  } else {
    playDeck = shuffled;
  }

  wrongCards = [];
  stats = { ok: 0, ng: 0 };
  currentCardIndex = 0;
  
  updateCardUI();
  showView('play');
}

function updateCardUI() {
  isFlipped = false;
  ui.card.classList.remove('flipped');
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ã‚’å°‘ã—å¾…ã£ã¦æ–‡å­—ã‚’æ›¸ãæ›ãˆã‚‹
  setTimeout(() => {
    const card = playDeck[currentCardIndex];
    ui.cardFront.textContent = card.front;
    ui.cardBack.textContent = card.back;
    ui.currNum.textContent = currentCardIndex + 1;
    ui.totalNum.textContent = playDeck.length;
    
    // ãƒœã‚¿ãƒ³çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
    ui.revealBtn.disabled = false;
    ui.okBtn.disabled = true;
    ui.ngBtn.disabled = true;
  }, 150);
}

function revealCard() {
  if (isFlipped) return;
  isFlipped = true;
  ui.card.classList.add('flipped');
  
  ui.revealBtn.disabled = true;
  ui.okBtn.disabled = false;
  ui.ngBtn.disabled = false;
}

function markCard(isOk) {
  if (!isFlipped) return;
  
  if (isOk) {
    stats.ok++;
    sounds.ok.currentTime = 0; sounds.ok.play().catch(e=>{});
  } else {
    stats.ng++;
    wrongCards.push(playDeck[currentCardIndex]);
    sounds.ng.currentTime = 0; sounds.ng.play().catch(e=>{});
  }
  
  currentCardIndex++;
  
  if (currentCardIndex >= playDeck.length) {
    setTimeout(showResult, 400); // æœ€å¾Œã®ã‚«ãƒ¼ãƒ‰å‡¦ç†å¾Œã«ãƒªã‚¶ãƒ«ãƒˆã¸
  } else {
    updateCardUI();
  }
}

// ãƒ—ãƒ¬ã‚¤ç”»é¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
ui.startTestBtn.addEventListener('click', startTest);
ui.card.addEventListener('click', revealCard);
ui.revealBtn.addEventListener('click', revealCard);
ui.okBtn.addEventListener('click', () => markCard(true));
ui.ngBtn.addEventListener('click', () => markCard(false));
ui.backHomeBtn.addEventListener('click', () => showView('start'));

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œå¯¾å¿œ
window.addEventListener('keydown', (e) => {
  if (views.play.classList.contains('active')) {
    if (e.code === 'Space') { e.preventDefault(); revealCard(); }
    if ((e.key.toLowerCase() === 'o' || e.key === 'ArrowRight') && !ui.okBtn.disabled) markCard(true);
    if ((e.key.toLowerCase() === 'x' || e.key === 'ArrowLeft') && !ui.ngBtn.disabled) markCard(false);
  }
});

// ==========================================
// 6. çµæœç”»é¢ãƒ­ã‚¸ãƒƒã‚¯
// ==========================================
function showResult() {
  const total = stats.ok + stats.ng;
  const ratio = Math.round((stats.ok / total) * 100) || 0;
  
  ui.resScore.textContent = `${ratio}%`;
  ui.resOk.textContent = stats.ok;
  ui.resNg.textContent = stats.ng;
  
  ui.newTitleMsg.style.display = 'none';
  ui.resultStamp.innerHTML = '';
  
  if (stats.ng > 0) {
    ui.resTitle.textContent = "ãŠã¤ã‹ã‚Œã•ã¾ï¼";
    ui.retryNgBtn.style.display = 'block';
  } else {
    ui.resTitle.textContent = "ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ğŸ‰";
    ui.retryNgBtn.style.display = 'none';
    
    // â˜… å®Ÿç¸¾æ›´æ–°
    const oldTitle = getTitle(achievements.perfects);
    achievements.perfects++;
    saveAchievements();
    const newTitle = getTitle(achievements.perfects);
    
    // â˜… ã¯ãªã¾ã‚‹ã‚¹ã‚¿ãƒ³ãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
    const stampEl = document.createElement('img');
    stampEl.src = 'https://raw.githubusercontent.com/byakusen/hanamaru/refs/heads/main/hanamaru2.png';
    stampEl.className = 'stamp-anim hanamaru-large';
    ui.resultStamp.appendChild(stampEl);
    
    if (oldTitle !== newTitle) {
      ui.newTitleName.textContent = newTitle;
      ui.newTitleMsg.style.display = 'block';
      setTimeout(triggerConfetti, 500); // ç§°å·ã‚¢ãƒƒãƒ—æ™‚ã¯å°‘ã—é…ã‚‰ã›ã¦è±ªè¯ã«
    } else {
      setTimeout(triggerConfetti, 300);
    }
    
    updateAchievementUI(); // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®è¡¨ç¤ºã‚’è£ã§æ›´æ–°
  }
  
  showView('result');
}

function triggerConfetti() {
  if (typeof confetti === 'function') {
    confetti({
      particleCount: 150,
      spread: 80,
      origin: { y: 0.6 },
      colors: ['#38bdf8', '#22c55e', '#a8edea', '#fed6e3']
    });
  }
}

// â˜… å…ˆç”Ÿã«å ±å‘Šã™ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
ui.reportBtn.addEventListener('click', () => {
  showInputModal("ã‚ãªãŸã®åå‰ã‚’æ•™ãˆã¦ãã ã•ã„", "", (studentName) => {
    if (studentName && studentName.trim()) {
      const total = stats.ok + stats.ng;
      const reportText = `${studentName}ã•ã‚“ï¼šã€Œ${currentSetName}ã€ ${total}å•ä¸­ ${stats.ok}å•æ­£è§£ã§ã—ãŸï¼`;
      
      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
      const tempInput = document.createElement('textarea');
      tempInput.value = reportText;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);
      
      showToast("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼å…ˆç”Ÿã«è²¼ã‚Šä»˜ã‘ã¦é€ã£ã¦ã­ã€‚");
    }
  });
});

ui.retryNgBtn.addEventListener('click', () => {
  // é–“é•ãˆãŸå•é¡Œã ã‘ã§å†æ§‹ç¯‰
  playDeck = [...wrongCards].sort(() => Math.random() - 0.5);
  wrongCards = [];
  stats = { ok: 0, ng: 0 };
  currentCardIndex = 0;
  updateCardUI();
  showView('play');
});

ui.retryAllBtn.addEventListener('click', startTest);
ui.toHomeBtn.addEventListener('click', () => showView('start'));

// ==========================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ==========================================
function showView(viewId) {
  Object.values(views).forEach(v => v.classList.remove('active'));
  views[viewId].classList.add('active');
}

// èµ·å‹•
initApp();
</script>
</body>
</html>